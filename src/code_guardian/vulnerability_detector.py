"""Vulnerability detection module for security analysis."""

import re
from typing import List, Dict, Any


class VulnerabilityDetector:
    """Detects security vulnerabilities in code."""
    
    SQL_INJECTION_PATTERNS = [
        r"execute\([^)]*%s",
        r"execute\([^)]*\+",
        r"cursor\.execute\([^)]*format",
    ]
    
    def __init__(self):
        self.vulnerabilities = []
        
    def detect(self, code: str, file_type: str = '.py') -> List[Dict[str, Any]]:
        """Detect vulnerabilities in code."""
        self.vulnerabilities = []
        
        if file_type == '.py':
            self._detect_python_vulnerabilities(code)
            
        self._detect_common_vulnerabilities(code)
        return self.vulnerabilities
    
    def _detect_python_vulnerabilities(self, code: str):
        """Detect Python-specific vulnerabilities."""
        for pattern in self.SQL_INJECTION_PATTERNS:
            if re.search(pattern, code):
                self.vulnerabilities.append({
                    "type": "SQL Injection Risk",
                    "severity": "HIGH",
                    "description": "Possible SQL injection vulnerability"
                })
        
        if re.search(r"\beval\(|\bexec\(", code):
            self.vulnerabilities.append({
                "type": "Code Injection",
                "severity": "CRITICAL",
                "description": "Use of eval() or exec() detected"
            })
    
    def _detect_common_vulnerabilities(self, code: str):
        """Detect common vulnerabilities."""
        secret_patterns = [
            r"password\s*=\s*['\"][^'\"]+['\"]",
            r"api[_-]?key\s*=\s*['\"][^'\"]+['\"]",
        ]
        
        for pattern in secret_patterns:
            if re.search(pattern, code, re.IGNORECASE):
                self.vulnerabilities.append({
                    "type": "Hardcoded Secret",
                    "severity": "CRITICAL",
                    "description": "Hardcoded credential detected"
                })
